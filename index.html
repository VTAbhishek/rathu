<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Personal Finance Manager</h1>
        
        <!-- Report Button -->
        <div class="report-section">
            <a href="generate_report.php" class="btn btn-report" target="_blank">
                <span>üìÑ</span> Generate PDF Report
            </a>
        </div>
        
        <!-- Balance Display -->
        <div class="balance-section">
            <div class="balance-card total">
                <h3>Total Income</h3>
                <p class="amount income" id="total-income">Rs. 0.00</p>
            </div>
            <div class="balance-card total">
                <h3>Total Outcome</h3>
                <p class="amount outcome" id="total-outcome">Rs. 0.00</p>
            </div>
            <div class="balance-card main">
                <h3>Current Balance</h3>
                <p class="amount balance" id="current-balance">Rs. 0.00</p>
            </div>
        </div>

        <!-- Forms Section -->
        <div class="forms-section">
            <!-- Add Income Form -->
            <div class="form-card">
                <h2>Add Income</h2>
                <form method="POST" action="process.php">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="income_description" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.01" name="income_amount" required>
                    </div>
                    <button type="submit" name="add_income" class="btn btn-income">Add Income</button>
                </form>
            </div>

            <!-- Add Outcome Form -->
            <div class="form-card">
                <h2>Add Outcome</h2>
                <form method="POST" action="process.php">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="outcome_description" required>
                    </div>
                    <div class="form-group">
                        <label>Bill Number</label>
                        <input type="text" name="bill_number" placeholder="Enter bill number">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.01" name="outcome_amount" required>
                    </div>
                    <button type="submit" name="add_outcome" class="btn btn-outcome">Add Outcome</button>
                </form>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="transaction-card">
            <h2>Income History</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="income-table-body">
                        <tr>
                            <td colspan="4" class="no-data">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="transaction-card">
            <h2>Outcome History</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Bill Number</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="outcome-table-body">
                        <tr>
                            <td colspan="5" class="no-data">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Function to format currency
        function formatCurrency(amount) {
            return 'Rs. ' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Function to load data
        function loadData() {
            fetch('process.php?ajax=true')
                .then(response => response.json())
                .then(data => {
                    // Update balance display
                    document.getElementById('total-income').textContent = formatCurrency(data.balance.total_income);
                    document.getElementById('total-outcome').textContent = formatCurrency(data.balance.total_outcome);
                    document.getElementById('current-balance').textContent = formatCurrency(data.balance.current_balance);

                    // Update income table
                    const incomeTableBody = document.getElementById('income-table-body');
                    if (data.incomes.length > 0) {
                        incomeTableBody.innerHTML = data.incomes.map(income => `
                            <tr>
                                <td>${escapeHtml(income.description)}</td>
                                <td class="amount-cell income">${formatCurrency(income.amount)}</td>
                                <td>${formatDate(income.date)}</td>
                                <td>
                                    <a href="process.php?delete_income=${income.id}" 
                                       class="btn-delete" 
                                       onclick="return confirm('Are you sure you want to delete this income record?');">
                                        üóëÔ∏è Delete
                                    </a>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        incomeTableBody.innerHTML = '<tr><td colspan="4" class="no-data">No income records found</td></tr>';
                    }

                    // Update outcome table
                    const outcomeTableBody = document.getElementById('outcome-table-body');
                    if (data.outcomes.length > 0) {
                        outcomeTableBody.innerHTML = data.outcomes.map(outcome => `
                            <tr>
                                <td>${escapeHtml(outcome.description)}</td>
                                <td>${escapeHtml(outcome.bill_number)}</td>
                                <td class="amount-cell outcome">${formatCurrency(outcome.amount)}</td>
                                <td>${formatDate(outcome.date)}</td>
                                <td>
                                    <a href="process.php?delete_outcome=${outcome.id}" 
                                       class="btn-delete" 
                                       onclick="return confirm('Are you sure you want to delete this outcome record?');">
                                        üóëÔ∏è Delete
                                    </a>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        outcomeTableBody.innerHTML = '<tr><td colspan="5" class="no-data">No outcome records found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        // Function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);

        // Reload data every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>