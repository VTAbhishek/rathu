<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Personal Finance Manager</h1>
        
        <!-- Report Button -->
        <div class="report-section">
            <a href="generate_report.php" class="btn btn-report" target="_blank">
                <span>üìÑ</span> Generate PDF Report
            </a>
        </div>
        
        <!-- Balance Display -->
        <div class="balance-section">
            <div class="balance-card total">
                <h3>Total Income</h3>
                <p class="amount income" id="total-income">Rs. 0.00</p>
            </div>
            <div class="balance-card total">
                <h3>Total Outcome</h3>
                <p class="amount outcome" id="total-outcome">Rs. 0.00</p>
            </div>
            <div class="balance-card main">
                <h3>Current Balance</h3>
                <p class="amount balance" id="current-balance">Rs. 0.00</p>
            </div>
        </div>

        <!-- Forms Section -->
        <div class="forms-section">
            <!-- Add Income Form -->
            <div class="form-card">
                <h2>Add Income</h2>
                <form method="POST" action="process.php">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="income_description" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.01" name="income_amount" required>
                    </div>
                    <button type="submit" name="add_income" class="btn btn-income">Add Income</button>
                </form>
            </div>

            <!-- Add Outcome Form -->
            <div class="form-card">
                <h2>Add Outcome</h2>
                <form method="POST" action="process.php">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="outcome_description" required>
                    </div>
                    <div class="form-group">
                        <label>Bill Number</label>
                        <input type="text" name="bill_number" placeholder="Enter bill number">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.01" name="outcome_amount" required>
                    </div>
                    <button type="submit" name="add_outcome" class="btn btn-outcome">Add Outcome</button>
                </form>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="transaction-card">
            <h2>Income History</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="income-table-body">
                        <tr>
                            <td colspan="4" class="no-data">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="transaction-card">
            <h2>Outcome History</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Bill Number</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="outcome-table-body">
                        <tr>
                            <td colspan="5" class="no-data">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display balance
        function loadBalance() {
            fetch('process.php?action=get_balance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-income').textContent = 'Rs. ' + parseFloat(data.total_income).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('total-outcome').textContent = 'Rs. ' + parseFloat(data.total_outcome).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('current-balance').textContent = 'Rs. ' + parseFloat(data.current_balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                })
                .catch(error => console.error('Error loading balance:', error));
        }

        // Fetch and display incomes
        function loadIncomes() {
            fetch('process.php?action=get_incomes')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('income-table-body');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No income records found</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(income => `
                            <tr>
                                <td>${escapeHtml(income.description)}</td>
                                <td class="amount-cell income">Rs. ${parseFloat(income.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>${formatDate(income.date)}</td>
                                <td>
                                    <a href="process.php?delete_income=${income.id}" 
                                       class="btn-delete" 
                                       onclick="return confirm('Are you sure you want to delete this income record?');">
                                        üóëÔ∏è Delete
                                    </a>
                                </td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(error => console.error('Error loading incomes:', error));
        }

        // Fetch and display outcomes
        function loadOutcomes() {
            fetch('process.php?action=get_outcomes')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('outcome-table-body');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No outcome records found</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(outcome => `
                            <tr>
                                <td>${escapeHtml(outcome.description)}</td>
                                <td>${escapeHtml(outcome.bill_number)}</td>
                                <td class="amount-cell outcome">Rs. ${parseFloat(outcome.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>${formatDate(outcome.date)}</td>
                                <td>
                                    <a href="process.php?delete_outcome=${outcome.id}" 
                                       class="btn-delete" 
                                       onclick="return confirm('Are you sure you want to delete this outcome record?');">
                                        üóëÔ∏è Delete
                                    </a>
                                </td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(error => console.error('Error loading outcomes:', error));
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Load all data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadBalance();
            loadIncomes();
            loadOutcomes();
        });
    </script>
</body>
</html>